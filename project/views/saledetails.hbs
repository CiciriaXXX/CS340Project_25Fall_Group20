 {{!--
 Citation for the following code:
 Date: 11/19/2025
 This file's structure is adapted from the OSU CS 340 starter code.
 All variables, queries, and application-specific logic have been rewritten 
 for our project requirements.
 https://canvas.oregonstate.edu/courses/2017561/pages/exploration-web-application-technology-2?module_item_id=25645131
 https://canvas.oregonstate.edu/courses/2017561/pages/exploration-implementing-cud-operations-in-your-app?module_item_id=25645149
 --}}
 
<h1>Sale Details</h1>

{{!-- READ TABLE --}}
<table id="saledetails-table">
    <thead>
        <tr>
            <th>Sale Detail ID</th>
            <th>Sale ID</th>
            <th>Product Name</th>
            <th>Quantity</th>
            <th>Unit Price</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {{#each saledetails}}
        <tr>
            <td>{{this.saleDetailID}}</td>
            <td>{{this.saleID}}</td>
            <td>{{this.productName}}</td>
            <td>{{this.quantity}}</td>
            <td>{{this.unitPrice}}</td>
            <td>
                {{!-- DELETE FORM (M:M Requirement) --}}
                <form id="delete-saledetail-form-{{this.saleDetailID}}" method="POST" action="/delete-saledetail">
                    <input type="hidden" name="saleDetailID" value="{{this.saleDetailID}}">
                    <button type="submit">Delete</button>
                </form>
            </td>
        </tr>
        {{/each}}
    </tbody>
</table>

{{!-- CREATE FORM --}}
<h2>Add a New Sale Detail</h2>
<p>To add a new detail, please select the Sale ID and Product, then enter the quantity and price.</p>
<form class="cuForm" id="create-saledetail-form" method="POST" action="/create-saledetail">
    
    <label for="create_sale_ID">Sale ID:</label>
    <select name="saleID" id="create_sale_ID" required>
        <option value="" disabled selected>Select a Sale</option>
        {{#each sales}}
        <option value="{{this.saleID}}">Sale #{{this.saleID}}</option>
        {{/each}}
    </select>

    <label for="create_product_ID">Product:</label>
    <select name="productID" id="create_product_ID" required>
        <option value="" disabled selected>Select a Product</option>
        {{#each products}}
        <option value="{{this.productID}}">{{this.productName}}</option>
        {{/each}}
    </select>

    <label for="create_quantity">Quantity:</label>
    <input type="number" name="quantity" id="create_quantity" min="1" required>

    <label for="create_unitPrice">Unit Price:</label>
    <input type="number" step="0.01" name="unitPrice" id="create_unitPrice" min="0" required>

    <input type="submit" value="Add Sale Detail">
</form>

{{!-- UPDATE FORM --}}
<h2>Update a Sale Detail</h2>
<p>Select the specific Sale Detail ID you wish to update.</p>
<form class="cuForm" id="update-saledetail-form" method="POST" action="/update-saledetail">
    
    <label for="update_saleDetail_ID">Select Sale Detail:</label>
    <select name="saleDetailID" id="update_saleDetailID" required>
        <option value="" disabled selected>Select a Detail to Update</option>
        {{#each saledetails}}
        <option value="{{this.saleDetailID}}">{{this.saleDetailID}} - {{this.productName}} (Sale #{{this.saleID}})</option>
        {{/each}}
    </select>

    <label for="update_saleID">New Sale ID:</label>
    <select name="saleID" id="update_saleID" required>
        <option value="" disabled selected>Select a Sale</option>
        {{#each sales}}
        <option value="{{this.saleID}}">Sale #{{this.saleID}}</option>
        {{/each}}
    </select>

    <label for="update_productID">New Product:</label>
    <select name="productID" id="update_productID" required>
        <option value="" disabled selected>Select a Product</option>
        {{#each products}}
        <option value="{{this.productID}}">{{this.productName}}</option>
        {{/each}}
    </select>

    <label for="update_quantity">New Quantity:</label>
    <input type="number" name="quantity" id="update_quantity" min="1" required>

    <label for="update_unitPrice">New Unit Price:</label>
    <input type="number" step="0.01" name="unitPrice" id="update_unitPrice" min="0" required>

    <input type="submit" value="Update Sale Detail">
</form>

<script>
    // Script to pre-fill update form fields based on selected sale detail
    document.getElementById("update_saleDetailID").addEventListener("change", async function() {
    const id = this.value;
    if (!id) return;

    const res = await fetch(`/api/saledetail/${id}`);
    const data = await res.json();

    document.getElementById("update_saleID").value = data.saleID;
    document.getElementById("update_productID").value = data.productID;
    document.getElementById("update_quantity").value = data.quantity;
    document.getElementById("update_unitPrice").value = data.unitPrice;
});
</script>
